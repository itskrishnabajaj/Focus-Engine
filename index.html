<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#0a0a0f">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Focus Engine">
  <meta name="description" content="Psychologically optimized daily execution system for serious exam prep">
  <title>Focus Engine</title>
  <link rel="manifest" href="manifest.json">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Sora:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* ═══════════════════════════════════════════
       CSS CUSTOM PROPERTIES — DESIGN TOKENS
    ═══════════════════════════════════════════ */
    :root {
      --bg:          #090910;
      --surface:     #111118;
      --card:        #18181f;
      --card-hover:  #1e1e28;
      --border:      rgba(255,255,255,0.07);
      --border-mid:  rgba(255,255,255,0.12);

      --indigo:      #6366f1;
      --indigo-dim:  rgba(99,102,241,0.15);
      --indigo-glow: rgba(99,102,241,0.35);
      --amber:       #f59e0b;
      --amber-dim:   rgba(245,158,11,0.12);
      --emerald:     #10b981;
      --emerald-dim: rgba(16,185,129,0.12);
      --rose:        #f43f5e;
      --rose-dim:    rgba(244,63,94,0.10);
      --slate:       #6b7294;

      --text-1: #eeeef5;
      --text-2: #9898b8;
      --text-3: #5a5a7a;

      --font-body: 'Sora', sans-serif;
      --font-mono: 'DM Mono', monospace;

      --radius-sm: 10px;
      --radius-md: 16px;
      --radius-lg: 22px;
      --radius-xl: 30px;

      --nav-h: 72px;
      --safe-bottom: env(safe-area-inset-bottom, 0px);

      --transition: 0.22s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Calm theme */
    [data-theme="calm"] { --indigo: #5b92d6; --indigo-dim: rgba(91,146,214,0.15); }
    /* Deep theme */
    [data-theme="deep"] { --indigo: #9b77dd; --indigo-dim: rgba(155,119,221,0.15); }

    /* ═══════════════════════════════════════════
       RESET & BASE
    ═══════════════════════════════════════════ */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { height: 100%; overflow: hidden; }
    body {
      height: 100%;
      background: var(--bg);
      color: var(--text-1);
      font-family: var(--font-body);
      font-size: 15px;
      line-height: 1.5;
      overflow: hidden;
      -webkit-font-smoothing: antialiased;
      touch-action: manipulation;
    }

    button { font-family: var(--font-body); border: none; background: none; cursor: pointer; color: inherit; }
    input, textarea, select { font-family: var(--font-body); }

    /* ═══════════════════════════════════════════
       APP SHELL
    ═══════════════════════════════════════════ */
    #app {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      max-width: 430px;
      margin: 0 auto;
      position: relative;
    }

    /* ═══════════════════════════════════════════
       SCROLLABLE CONTENT AREA
    ═══════════════════════════════════════════ */
    .tab-content {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
      padding-bottom: calc(var(--nav-h) + var(--safe-bottom) + 12px);
    }

    /* Custom scrollbar */
    .tab-content::-webkit-scrollbar { width: 0; }

    /* ═══════════════════════════════════════════
       NAVIGATION BAR
    ═══════════════════════════════════════════ */
    .nav-bar {
      position: fixed;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      max-width: 430px;
      height: calc(var(--nav-h) + var(--safe-bottom));
      padding-bottom: var(--safe-bottom);
      background: rgba(17, 17, 24, 0.92);
      backdrop-filter: blur(20px) saturate(1.4);
      -webkit-backdrop-filter: blur(20px) saturate(1.4);
      border-top: 1px solid var(--border);
      display: flex;
      align-items: stretch;
      z-index: 100;
    }

    .nav-item {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      padding: 0;
      color: var(--text-3);
      transition: color var(--transition);
      -webkit-tap-highlight-color: transparent;
      position: relative;
    }

    .nav-item.active { color: var(--indigo); }

    .nav-item.active::before {
      content: '';
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 32px;
      height: 2px;
      background: var(--indigo);
      border-radius: 0 0 4px 4px;
      box-shadow: 0 0 8px var(--indigo-glow);
    }

    .nav-icon {
      width: 22px;
      height: 22px;
      stroke: currentColor;
      fill: none;
      stroke-width: 1.75;
      stroke-linecap: round;
      stroke-linejoin: round;
      transition: transform var(--transition);
    }

    .nav-item.active .nav-icon { transform: translateY(-1px); }

    .nav-label {
      font-size: 10px;
      font-weight: 500;
      letter-spacing: 0.04em;
    }

    /* ═══════════════════════════════════════════
       TAB PANELS
    ═══════════════════════════════════════════ */
    .tab-panel {
      display: none;
      animation: fadeSlideUp 0.28s cubic-bezier(0.4,0,0.2,1);
    }
    .tab-panel.active { display: block; }

    @keyframes fadeSlideUp {
      from { opacity: 0; transform: translateY(8px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    /* ═══════════════════════════════════════════
       HOME TAB
    ═══════════════════════════════════════════ */
    .home-header {
      padding: 20px 20px 0;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }

    .greeting-block { flex: 1; }

    .greeting-label {
      font-size: 12px;
      font-weight: 500;
      color: var(--text-3);
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .live-time {
      font-family: var(--font-mono);
      font-size: 28px;
      font-weight: 500;
      color: var(--text-1);
      letter-spacing: -0.02em;
      line-height: 1.1;
      margin-top: 2px;
    }

    .live-date {
      font-size: 12px;
      color: var(--text-2);
      margin-top: 3px;
    }

    /* Countdown ring */
    .ring-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 28px 20px 20px;
    }

    .ring-wrapper {
      position: relative;
      width: 168px;
      height: 168px;
    }

    .ring-svg {
      width: 100%;
      height: 100%;
      transform: rotate(-90deg);
    }

    .ring-track {
      fill: none;
      stroke: var(--surface);
      stroke-width: 10;
    }

    .ring-progress {
      fill: none;
      stroke: var(--indigo);
      stroke-width: 10;
      stroke-linecap: round;
      filter: drop-shadow(0 0 6px var(--indigo-glow));
      transition: stroke-dashoffset 1s linear, stroke 2s ease;
    }

    .ring-inner {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 2px;
    }

    .ring-label {
      font-size: 10px;
      font-weight: 500;
      color: var(--text-3);
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }

    .ring-value {
      font-family: var(--font-mono);
      font-size: 24px;
      font-weight: 400;
      color: var(--text-1);
      letter-spacing: -0.02em;
    }

    .ring-subtext {
      font-size: 11px;
      color: var(--text-3);
    }

    /* Day Completion Strip */
    .completion-strip {
      margin: 0 20px 20px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: 14px 16px;
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .completion-bar-wrap {
      flex: 1;
    }

    .completion-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .completion-title {
      font-size: 12px;
      font-weight: 500;
      color: var(--text-2);
    }

    .completion-pct {
      font-family: var(--font-mono);
      font-size: 12px;
      color: var(--emerald);
      font-weight: 500;
    }

    .completion-bar {
      height: 5px;
      background: var(--surface);
      border-radius: 99px;
      overflow: hidden;
    }

    .completion-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--emerald), #34d399);
      border-radius: 99px;
      transition: width 0.6s cubic-bezier(0.4,0,0.2,1);
    }

    .completion-stat {
      font-family: var(--font-mono);
      font-size: 11px;
      color: var(--text-3);
      white-space: nowrap;
    }

    /* Section headers */
    .section-header {
      padding: 0 20px 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .section-title {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-3);
      letter-spacing: 0.1em;
      text-transform: uppercase;
    }

    .section-action {
      font-size: 12px;
      color: var(--indigo);
      font-weight: 500;
    }

    /* Subject Cards */
    .subjects-list {
      padding: 0 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px;
    }

    .subject-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: 14px 16px;
      transition: background var(--transition), border-color var(--transition);
      -webkit-tap-highlight-color: transparent;
    }

    .subject-card:active { background: var(--card-hover); border-color: var(--border-mid); }

    .subject-card-top {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 10px;
    }

    .subject-info { flex: 1; }

    .subject-name {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-1);
    }

    .subject-topics {
      font-size: 12px;
      color: var(--text-2);
      margin-top: 3px;
      line-height: 1.4;
    }

    .subject-time {
      font-family: var(--font-mono);
      font-size: 13px;
      color: var(--text-2);
      white-space: nowrap;
      padding-top: 2px;
    }

    .subject-time.done { color: var(--emerald); }

    .subject-progress {
      height: 3px;
      background: var(--surface);
      border-radius: 99px;
      overflow: hidden;
    }

    .subject-progress-fill {
      height: 100%;
      border-radius: 99px;
      transition: width 0.5s cubic-bezier(0.4,0,0.2,1);
    }

    /* Subject color dots */
    .subject-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-top: 4px;
      flex-shrink: 0;
      margin-right: 10px;
    }

    .subject-name-row {
      display: flex;
      align-items: flex-start;
    }

    /* CTA Button */
    .cta-wrap {
      padding: 6px 20px 20px;
    }

    .btn-primary {
      width: 100%;
      height: 56px;
      background: linear-gradient(135deg, var(--indigo) 0%, #818cf8 100%);
      color: #fff;
      border-radius: var(--radius-lg);
      font-size: 15px;
      font-weight: 600;
      letter-spacing: 0.02em;
      box-shadow: 0 4px 24px var(--indigo-glow), 0 1px 3px rgba(0,0,0,0.4);
      transition: opacity var(--transition), transform var(--transition), box-shadow var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      -webkit-tap-highlight-color: transparent;
    }

    .btn-primary:active {
      opacity: 0.85;
      transform: scale(0.98);
      box-shadow: 0 2px 12px var(--indigo-glow);
    }

    .btn-secondary {
      height: 48px;
      padding: 0 24px;
      background: var(--card);
      border: 1px solid var(--border-mid);
      color: var(--text-2);
      border-radius: var(--radius-md);
      font-size: 14px;
      font-weight: 500;
      transition: background var(--transition);
      -webkit-tap-highlight-color: transparent;
    }

    .btn-secondary:active { background: var(--card-hover); }

    .btn-icon-sm {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--surface);
      display: flex;
      align-items: center;
      justify-content: center;
      -webkit-tap-highlight-color: transparent;
      transition: background var(--transition);
    }
    .btn-icon-sm:active { background: var(--card); }

    /* Empty state */
    .empty-state {
      padding: 40px 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      text-align: center;
    }

    .empty-icon {
      width: 52px;
      height: 52px;
      background: var(--card);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--border);
    }

    .empty-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-1);
    }

    .empty-sub {
      font-size: 13px;
      color: var(--text-3);
      line-height: 1.5;
      max-width: 260px;
    }

    /* ═══════════════════════════════════════════
       FOCUS SESSION OVERLAY
    ═══════════════════════════════════════════ */
    .session-overlay {
      position: fixed;
      inset: 0;
      z-index: 200;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: space-between;
      padding: 60px 30px 50px;
    }

    .session-overlay.active { display: flex; }

    .session-bg {
      position: absolute;
      inset: 0;
      background: var(--bg);
      z-index: -1;
    }

    .session-gradient {
      position: absolute;
      width: 320px;
      height: 320px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(99,102,241,0.18) 0%, transparent 70%);
      top: 50%;
      left: 50%;
      transform: translate(-50%, -60%);
      z-index: -1;
      animation: breathe 4s ease-in-out infinite;
    }

    @keyframes breathe {
      0%, 100% { transform: translate(-50%, -60%) scale(1); opacity: 0.8; }
      50%       { transform: translate(-50%, -60%) scale(1.15); opacity: 1; }
    }

    .session-top {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      width: 100%;
    }

    .session-label {
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--text-3);
    }

    .session-subject {
      font-size: 20px;
      font-weight: 600;
      color: var(--text-1);
      text-align: center;
    }

    .session-topic {
      font-size: 13px;
      color: var(--text-2);
      text-align: center;
    }

    .session-timer {
      font-family: var(--font-mono);
      font-size: 80px;
      font-weight: 300;
      color: var(--text-1);
      letter-spacing: -0.04em;
      line-height: 1;
      text-shadow: 0 0 60px rgba(99,102,241,0.3);
    }

    .session-status {
      font-size: 12px;
      color: var(--text-3);
      letter-spacing: 0.06em;
    }

    .session-controls {
      display: flex;
      gap: 16px;
      width: 100%;
      justify-content: center;
    }

    .btn-session-end {
      height: 52px;
      flex: 1;
      max-width: 140px;
      background: var(--card);
      border: 1px solid var(--border-mid);
      border-radius: var(--radius-md);
      font-size: 14px;
      font-weight: 500;
      color: var(--text-2);
      -webkit-tap-highlight-color: transparent;
      transition: background var(--transition);
    }
    .btn-session-end:active { background: var(--card-hover); }

    .btn-session-pause {
      height: 52px;
      flex: 1;
      max-width: 160px;
      background: linear-gradient(135deg, var(--indigo), #818cf8);
      border-radius: var(--radius-md);
      font-size: 14px;
      font-weight: 600;
      color: #fff;
      -webkit-tap-highlight-color: transparent;
      box-shadow: 0 4px 20px var(--indigo-glow);
      transition: opacity var(--transition);
    }
    .btn-session-pause:active { opacity: 0.8; }

    /* ═══════════════════════════════════════════
       PLAN TAB
    ═══════════════════════════════════════════ */
    .plan-header {
      padding: 24px 20px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .plan-title {
      font-size: 22px;
      font-weight: 700;
      color: var(--text-1);
    }

    .btn-add {
      width: 40px;
      height: 40px;
      background: var(--indigo-dim);
      border: 1px solid rgba(99,102,241,0.3);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--indigo);
      -webkit-tap-highlight-color: transparent;
      transition: background var(--transition);
    }
    .btn-add:active { background: rgba(99,102,241,0.25); }

    .days-list {
      padding: 0 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .day-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      overflow: hidden;
    }

    .day-card-header {
      display: flex;
      align-items: center;
      padding: 14px 16px;
      gap: 12px;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }

    .day-card-header:active { background: var(--card-hover); }

    .day-number-badge {
      font-family: var(--font-mono);
      font-size: 11px;
      font-weight: 500;
      color: var(--indigo);
      background: var(--indigo-dim);
      border: 1px solid rgba(99,102,241,0.2);
      border-radius: 6px;
      padding: 3px 8px;
      white-space: nowrap;
    }

    .day-info { flex: 1; }

    .day-label {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-1);
    }

    .day-meta {
      font-size: 12px;
      color: var(--text-3);
      margin-top: 2px;
    }

    .day-chevron {
      width: 18px;
      height: 18px;
      stroke: var(--text-3);
      fill: none;
      stroke-width: 2;
      stroke-linecap: round;
      transition: transform var(--transition);
    }

    .day-card.expanded .day-chevron { transform: rotate(90deg); }

    .day-tasks {
      display: none;
      border-top: 1px solid var(--border);
    }

    .day-card.expanded .day-tasks { display: block; }

    .task-item {
      display: flex;
      align-items: center;
      padding: 11px 16px;
      border-bottom: 1px solid var(--border);
      gap: 12px;
    }

    .task-item:last-child { border-bottom: none; }

    .task-check {
      width: 20px;
      height: 20px;
      border-radius: 6px;
      border: 1.5px solid var(--border-mid);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: background var(--transition), border-color var(--transition);
      -webkit-tap-highlight-color: transparent;
    }

    .task-check.done {
      background: var(--emerald);
      border-color: var(--emerald);
    }

    .task-info { flex: 1; }

    .task-subject {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.07em;
      margin-bottom: 2px;
    }

    .task-topic {
      font-size: 13px;
      color: var(--text-2);
    }

    .task-time {
      font-family: var(--font-mono);
      font-size: 12px;
      color: var(--text-3);
    }

    .task-delete {
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-3);
      border-radius: 6px;
      -webkit-tap-highlight-color: transparent;
    }
    .task-delete:active { background: var(--rose-dim); color: var(--rose); }

    .day-add-task {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 16px;
      color: var(--indigo);
      font-size: 13px;
      font-weight: 500;
      -webkit-tap-highlight-color: transparent;
    }

    /* Import strip */
    .import-strip {
      margin: 16px 16px 6px;
      background: linear-gradient(135deg, rgba(99,102,241,0.08), rgba(129,140,248,0.05));
      border: 1px solid rgba(99,102,241,0.2);
      border-radius: var(--radius-md);
      padding: 14px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .import-text { flex: 1; }
    .import-title { font-size: 13px; font-weight: 600; color: var(--text-1); }
    .import-sub { font-size: 11px; color: var(--text-3); margin-top: 2px; }

    .btn-import {
      height: 34px;
      padding: 0 14px;
      background: var(--indigo);
      color: #fff;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      -webkit-tap-highlight-color: transparent;
      white-space: nowrap;
    }

    /* ═══════════════════════════════════════════
       BACKLOG TAB
    ═══════════════════════════════════════════ */
    .backlog-header {
      padding: 24px 20px 6px;
    }

    .backlog-title {
      font-size: 22px;
      font-weight: 700;
      color: var(--text-1);
    }

    .backlog-sub {
      font-size: 13px;
      color: var(--text-3);
      margin-top: 6px;
      line-height: 1.5;
    }

    .backlog-stats {
      margin: 16px 20px;
      display: flex;
      gap: 10px;
    }

    .stat-chip {
      flex: 1;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 12px 14px;
      text-align: center;
    }

    .stat-chip-value {
      font-family: var(--font-mono);
      font-size: 20px;
      font-weight: 400;
      color: var(--text-1);
    }

    .stat-chip-label {
      font-size: 10px;
      color: var(--text-3);
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-top: 2px;
    }

    .pending-list {
      padding: 0 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .pending-item {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: 14px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .pending-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .pending-info { flex: 1; }

    .pending-subject {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.07em;
      margin-bottom: 3px;
    }

    .pending-topic {
      font-size: 13px;
      color: var(--text-2);
    }

    .pending-origin {
      font-size: 11px;
      color: var(--text-3);
      margin-top: 2px;
    }

    .pending-time {
      font-family: var(--font-mono);
      font-size: 12px;
      color: var(--amber);
    }

    .btn-reassign {
      height: 30px;
      padding: 0 10px;
      border: 1px solid var(--border-mid);
      border-radius: 7px;
      font-size: 11px;
      font-weight: 500;
      color: var(--text-2);
      white-space: nowrap;
      -webkit-tap-highlight-color: transparent;
      transition: background var(--transition);
    }
    .btn-reassign:active { background: var(--card-hover); }

    /* ═══════════════════════════════════════════
       PROGRESS TAB
    ═══════════════════════════════════════════ */
    .progress-header {
      padding: 24px 20px 16px;
    }

    .progress-title {
      font-size: 22px;
      font-weight: 700;
      color: var(--text-1);
    }

    .progress-date-range {
      font-size: 12px;
      color: var(--text-3);
      margin-top: 4px;
    }

    .metric-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      padding: 0 16px 16px;
    }

    .metric-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: 16px;
    }

    .metric-card.accent-indigo {
      background: var(--indigo-dim);
      border-color: rgba(99,102,241,0.2);
    }

    .metric-label {
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-3);
      margin-bottom: 8px;
    }

    .metric-value {
      font-family: var(--font-mono);
      font-size: 28px;
      font-weight: 400;
      color: var(--text-1);
      letter-spacing: -0.02em;
    }

    .metric-sub {
      font-size: 11px;
      color: var(--text-3);
      margin-top: 4px;
    }

    .consistency-row {
      margin: 0 16px 16px;
    }

    .consistency-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-3);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 12px;
    }

    .week-dots {
      display: flex;
      gap: 8px;
      align-items: flex-end;
    }

    .week-day-col {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
    }

    .week-bar {
      width: 100%;
      background: var(--surface);
      border-radius: 4px;
      overflow: hidden;
      height: 64px;
      display: flex;
      align-items: flex-end;
    }

    .week-bar-fill {
      width: 100%;
      border-radius: 4px;
      background: linear-gradient(180deg, var(--indigo), rgba(99,102,241,0.5));
      transition: height 0.6s cubic-bezier(0.4,0,0.2,1);
    }

    .week-day-label {
      font-size: 10px;
      color: var(--text-3);
      font-weight: 500;
    }

    .subject-dist {
      margin: 0 16px 16px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: 16px;
    }

    .dist-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-3);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 14px;
    }

    .dist-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .dist-row:last-child { margin-bottom: 0; }

    .dist-subject {
      font-size: 12px;
      font-weight: 500;
      color: var(--text-2);
      width: 70px;
      flex-shrink: 0;
    }

    .dist-bar-wrap {
      flex: 1;
      height: 6px;
      background: var(--surface);
      border-radius: 99px;
      overflow: hidden;
    }

    .dist-bar-fill {
      height: 100%;
      border-radius: 99px;
    }

    .dist-pct {
      font-family: var(--font-mono);
      font-size: 11px;
      color: var(--text-3);
      width: 34px;
      text-align: right;
    }

    .encourage-card {
      margin: 0 16px 16px;
      background: linear-gradient(135deg, rgba(16,185,129,0.08), rgba(52,211,153,0.04));
      border: 1px solid rgba(16,185,129,0.2);
      border-radius: var(--radius-md);
      padding: 16px;
    }

    .encourage-text {
      font-size: 14px;
      color: var(--text-1);
      line-height: 1.6;
      font-style: italic;
    }

    /* ═══════════════════════════════════════════
       SETTINGS TAB
    ═══════════════════════════════════════════ */
    .settings-header {
      padding: 24px 20px 16px;
    }

    .settings-title {
      font-size: 22px;
      font-weight: 700;
      color: var(--text-1);
    }

    .settings-group {
      margin: 0 16px 16px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      overflow: hidden;
    }

    .settings-group-label {
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-3);
      padding: 14px 16px 8px;
    }

    .setting-row {
      display: flex;
      align-items: center;
      padding: 14px 16px;
      border-top: 1px solid var(--border);
      gap: 12px;
    }

    .setting-row:first-of-type { border-top: none; }

    .setting-label-wrap { flex: 1; }

    .setting-label {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-1);
    }

    .setting-desc {
      font-size: 12px;
      color: var(--text-3);
      margin-top: 2px;
    }

    /* Toggle switch */
    .toggle {
      width: 46px;
      height: 26px;
      background: var(--surface);
      border-radius: 13px;
      border: 1.5px solid var(--border-mid);
      position: relative;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      transition: background var(--transition), border-color var(--transition);
      flex-shrink: 0;
    }

    .toggle.on {
      background: var(--indigo);
      border-color: transparent;
    }

    .toggle::after {
      content: '';
      width: 18px;
      height: 18px;
      background: #fff;
      border-radius: 50%;
      position: absolute;
      top: 3px;
      left: 3px;
      transition: transform var(--transition);
      box-shadow: 0 1px 4px rgba(0,0,0,0.3);
    }

    .toggle.on::after { transform: translateX(20px); }

    /* Time input */
    .time-input {
      background: var(--surface);
      border: 1px solid var(--border-mid);
      border-radius: 8px;
      padding: 7px 12px;
      font-family: var(--font-mono);
      font-size: 14px;
      color: var(--text-1);
      width: 90px;
      text-align: center;
      -webkit-tap-highlight-color: transparent;
    }

    .time-input:focus {
      outline: none;
      border-color: var(--indigo);
    }

    /* Theme chips */
    .theme-chips {
      display: flex;
      gap: 8px;
      padding: 0 16px 14px;
    }

    .theme-chip {
      flex: 1;
      height: 36px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      border: 1.5px solid var(--border);
      color: var(--text-2);
      -webkit-tap-highlight-color: transparent;
      transition: border-color var(--transition), color var(--transition);
    }

    .theme-chip.active {
      border-color: var(--indigo);
      color: var(--indigo);
      background: var(--indigo-dim);
    }

    /* ═══════════════════════════════════════════
       MODALS / SHEETS
    ═══════════════════════════════════════════ */
    .sheet-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(4px);
      z-index: 150;
      display: none;
      animation: fadeIn 0.2s ease;
    }

    .sheet-backdrop.active { display: block; }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    .bottom-sheet {
      position: fixed;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      max-width: 430px;
      background: var(--surface);
      border-radius: 24px 24px 0 0;
      border-top: 1px solid var(--border-mid);
      z-index: 151;
      padding: 0 0 calc(30px + var(--safe-bottom));
      display: none;
      animation: slideUp 0.3s cubic-bezier(0.34,1.56,0.64,1);
    }

    .bottom-sheet.active { display: block; }

    @keyframes slideUp {
      from { transform: translateX(-50%) translateY(100%); }
      to   { transform: translateX(-50%) translateY(0); }
    }

    .sheet-handle {
      width: 36px;
      height: 4px;
      background: var(--border-mid);
      border-radius: 99px;
      margin: 12px auto 16px;
    }

    .sheet-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--text-1);
      padding: 0 20px 16px;
    }

    .form-group {
      padding: 0 20px 14px;
    }

    .form-label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.07em;
      color: var(--text-3);
      margin-bottom: 8px;
      display: block;
    }

    .form-input {
      width: 100%;
      background: var(--card);
      border: 1px solid var(--border-mid);
      border-radius: var(--radius-sm);
      padding: 13px 14px;
      font-size: 14px;
      color: var(--text-1);
      transition: border-color var(--transition);
    }

    .form-input:focus {
      outline: none;
      border-color: var(--indigo);
    }

    .form-input::placeholder { color: var(--text-3); }

    .form-row {
      display: flex;
      gap: 10px;
      padding: 0 20px 14px;
    }

    .form-row .form-group {
      flex: 1;
      padding: 0;
    }

    .sheet-actions {
      display: flex;
      gap: 10px;
      padding: 6px 20px 0;
    }

    /* Subject select */
    .subject-select {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      padding: 0 20px 14px;
    }

    .subj-chip {
      height: 32px;
      padding: 0 12px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      border: 1.5px solid var(--border);
      color: var(--text-2);
      transition: all var(--transition);
      -webkit-tap-highlight-color: transparent;
    }

    .subj-chip.active { border-color: var(--indigo); color: var(--indigo); background: var(--indigo-dim); }

    /* Session picker */
    .session-subject-list {
      padding: 0 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 380px;
      overflow-y: auto;
    }

    .session-pick-item {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: 14px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      -webkit-tap-highlight-color: transparent;
    }

    .session-pick-item:active { background: var(--card-hover); }

    .pick-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .pick-info { flex: 1; }

    .pick-subj {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 2px;
    }

    .pick-topic { font-size: 13px; color: var(--text-2); }
    .pick-time { font-family: var(--font-mono); font-size: 12px; color: var(--text-3); }

    /* ═══════════════════════════════════════════
       TOAST NOTIFICATIONS
    ═══════════════════════════════════════════ */
    #toast-container {
      position: fixed;
      top: 16px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 300;
      width: calc(100% - 32px);
      max-width: 398px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      pointer-events: none;
    }

    .toast {
      background: var(--card);
      border: 1px solid var(--border-mid);
      border-radius: var(--radius-md);
      padding: 12px 16px;
      font-size: 13px;
      color: var(--text-1);
      box-shadow: 0 8px 32px rgba(0,0,0,0.4);
      animation: toastIn 0.3s cubic-bezier(0.34,1.56,0.64,1);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    @keyframes toastIn {
      from { opacity: 0; transform: translateY(-12px) scale(0.94); }
      to   { opacity: 1; transform: translateY(0) scale(1); }
    }

    .toast.success { border-color: rgba(16,185,129,0.3); }
    .toast.error   { border-color: rgba(244,63,94,0.3); }

    /* Loading pulse */
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50%       { opacity: 0.5; }
    }
    .loading { animation: pulse 1.5s ease infinite; }

    /* ═══════════════════════════════════════════
       MISC UTILITIES
    ═══════════════════════════════════════════ */
    .divider {
      height: 1px;
      background: var(--border);
      margin: 0 16px;
    }

    .mt-4  { margin-top: 16px; }
    .mb-4  { margin-bottom: 16px; }
    .flex  { display: flex; }
    .items-center { align-items: center; }
    .gap-2 { gap: 8px; }

    .badge {
      display: inline-flex;
      align-items: center;
      height: 20px;
      padding: 0 7px;
      border-radius: 6px;
      font-size: 10px;
      font-weight: 600;
      letter-spacing: 0.04em;
    }

    .badge-emerald { background: var(--emerald-dim); color: var(--emerald); }
    .badge-amber   { background: var(--amber-dim);   color: var(--amber);   }
    .badge-indigo  { background: var(--indigo-dim);  color: var(--indigo);  }
  </style>
</head>
<body>

<div id="toast-container"></div>

<!-- ═══════ MAIN APP ═══════ -->
<div id="app">
  <div class="tab-content" id="tabContent">

    <!-- ════════════ HOME TAB ════════════ -->
    <div class="tab-panel active" id="tab-home">
      <div class="home-header">
        <div class="greeting-block">
          <div class="greeting-label" id="greeting">Good morning</div>
          <div class="live-time" id="liveTime">--:--</div>
          <div class="live-date" id="liveDate">Loading...</div>
        </div>
        <div class="btn-icon-sm" id="btnDayLabel" title="Today's plan label">
          <svg class="nav-icon" style="width:18px;height:18px" viewBox="0 0 24 24">
            <path d="M12 5v14M5 12h14"/>
          </svg>
        </div>
      </div>

      <!-- Countdown Ring -->
      <div class="ring-container">
        <div class="ring-wrapper">
          <svg class="ring-svg" viewBox="0 0 168 168">
            <circle class="ring-track" cx="84" cy="84" r="74"/>
            <circle class="ring-progress" id="ringProgress" cx="84" cy="84" r="74"
              stroke-dasharray="465" stroke-dashoffset="465"/>
          </svg>
          <div class="ring-inner">
            <div class="ring-label">Day ends in</div>
            <div class="ring-value" id="ringValue">--h --m</div>
            <div class="ring-subtext" id="ringEnd">ends at --:--</div>
          </div>
        </div>
      </div>

      <!-- Completion Strip -->
      <div class="completion-strip">
        <div class="completion-bar-wrap">
          <div class="completion-header">
            <span class="completion-title">Today's Completion</span>
            <span class="completion-pct" id="completionPct">0%</span>
          </div>
          <div class="completion-bar">
            <div class="completion-fill" id="completionFill" style="width:0%"></div>
          </div>
        </div>
        <div class="completion-stat" id="completionStat">0 / 0 tasks</div>
      </div>

      <!-- Subject cards -->
      <div class="section-header">
        <div class="section-title">Today's Targets</div>
        <div class="section-action" id="todayDayLabel">—</div>
      </div>

      <div class="subjects-list" id="subjectList">
        <div class="empty-state">
          <div class="empty-icon">
            <svg width="24" height="24" fill="none" stroke="#5a5a7a" stroke-width="1.5" viewBox="0 0 24 24">
              <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
            </svg>
          </div>
          <div class="empty-title">No tasks for today</div>
          <div class="empty-sub">Head to Plan tab to set up today's study targets.</div>
        </div>
      </div>

      <!-- CTA -->
      <div class="cta-wrap">
        <button class="btn-primary" id="btnStartSession">
          <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <polygon points="5,3 19,12 5,21"/>
          </svg>
          Start Focus Session
        </button>
      </div>
    </div>

    <!-- ════════════ PLAN TAB ════════════ -->
    <div class="tab-panel" id="tab-plan">
      <div class="plan-header">
        <div class="plan-title">Study Plan</div>
        <button class="btn-add" id="btnAddDay" title="Add study day">
          <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M12 5v14M5 12h14"/>
          </svg>
        </button>
      </div>

      <!-- PDF Import strip -->
      <div class="import-strip">
        <div class="import-text">
          <div class="import-title">Import Study Plan</div>
          <div class="import-sub">Parse a structured PDF automatically</div>
        </div>
        <button class="btn-import" id="btnImportPDF">Import PDF</button>
        <input type="file" id="pdfFileInput" accept=".pdf,application/pdf" style="display:none">
      </div>

      <div class="days-list" id="daysList">
        <div class="empty-state">
          <div class="empty-icon">
            <svg width="24" height="24" fill="none" stroke="#5a5a7a" stroke-width="1.5" viewBox="0 0 24 24">
              <path d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01"/>
            </svg>
          </div>
          <div class="empty-title">Plan is empty</div>
          <div class="empty-sub">Add study days or import a PDF plan to get started.</div>
        </div>
      </div>
    </div>

    <!-- ════════════ BACKLOG TAB ════════════ -->
    <div class="tab-panel" id="tab-backlog">
      <div class="backlog-header">
        <div class="backlog-title">Pending Units</div>
        <div class="backlog-sub">Tasks from previous days waiting to be absorbed into your flow.</div>
      </div>

      <div class="backlog-stats" id="backlogStats">
        <div class="stat-chip">
          <div class="stat-chip-value" id="backlogCount">0</div>
          <div class="stat-chip-label">Pending</div>
        </div>
        <div class="stat-chip">
          <div class="stat-chip-value" id="backlogMins">0</div>
          <div class="stat-chip-label">Minutes</div>
        </div>
        <div class="stat-chip">
          <div class="stat-chip-value" id="backlogDays">0</div>
          <div class="stat-chip-label">Days old</div>
        </div>
      </div>

      <div class="section-header">
        <div class="section-title">Pending Units</div>
      </div>

      <div class="pending-list" id="pendingList">
        <div class="empty-state">
          <div class="empty-icon">
            <svg width="24" height="24" fill="none" stroke="#5a5a7a" stroke-width="1.5" viewBox="0 0 24 24">
              <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
          </div>
          <div class="empty-title">All clear</div>
          <div class="empty-sub">No pending units. Your flow is uninterrupted.</div>
        </div>
      </div>
    </div>

    <!-- ════════════ PROGRESS TAB ════════════ -->
    <div class="tab-panel" id="tab-progress">
      <div class="progress-header">
        <div class="progress-title">Progress</div>
        <div class="progress-date-range" id="progressRange">Last 7 days</div>
      </div>

      <div class="metric-grid">
        <div class="metric-card accent-indigo">
          <div class="metric-label">Consistency</div>
          <div class="metric-value" id="metricConsistency">0%</div>
          <div class="metric-sub" id="metricConsistencySub">0 of 7 days</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Total Focus</div>
          <div class="metric-value" id="metricTotal">0h</div>
          <div class="metric-sub" id="metricTotalSub">this week</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Sessions</div>
          <div class="metric-value" id="metricSessions">0</div>
          <div class="metric-sub">completed</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Daily Avg</div>
          <div class="metric-value" id="metricAvg">0m</div>
          <div class="metric-sub">focus time</div>
        </div>
      </div>

      <!-- Weekly bar chart -->
      <div class="consistency-row" style="background:var(--card);border:1px solid var(--border);border-radius:var(--radius-md);padding:16px;margin:0 16px 16px;">
        <div class="consistency-title">Daily Focus Time (mins)</div>
        <div class="week-dots" id="weekBars">
          <!-- Generated by JS -->
        </div>
      </div>

      <!-- Subject distribution -->
      <div class="subject-dist">
        <div class="dist-title">Subject Distribution</div>
        <div id="subjectDist">
          <div style="font-size:13px;color:var(--text-3);text-align:center;padding:10px 0">No sessions yet</div>
        </div>
      </div>

      <!-- Encouragement card -->
      <div class="encourage-card">
        <div class="encourage-text" id="encourageText">
          "Every expert was once a beginner. Every pro was once an amateur."
        </div>
      </div>

      <!-- Spacer -->
      <div style="height:8px"></div>
    </div>

    <!-- ════════════ SETTINGS TAB ════════════ -->
    <div class="tab-panel" id="tab-settings">
      <div class="settings-header">
        <div class="settings-title">Settings</div>
      </div>

      <!-- Day Config -->
      <div class="settings-group">
        <div class="settings-group-label">Day Configuration</div>
        <div class="setting-row">
          <div class="setting-label-wrap">
            <div class="setting-label">Day End Time</div>
            <div class="setting-desc">When your study day closes</div>
          </div>
          <input type="time" class="time-input" id="settingEndTime" value="23:00">
        </div>
        <div class="setting-row">
          <div class="setting-label-wrap">
            <div class="setting-label">Day Start Time</div>
            <div class="setting-desc">When your day begins</div>
          </div>
          <input type="time" class="time-input" id="settingStartTime" value="06:00">
        </div>
      </div>

      <!-- Notifications -->
      <div class="settings-group">
        <div class="settings-group-label">Notifications</div>
        <div class="setting-row">
          <div class="setting-label-wrap">
            <div class="setting-label">Morning Nudge</div>
            <div class="setting-desc">Daily activation reminder</div>
          </div>
          <div class="toggle" id="toggleMorning" onclick="App.toggleSetting(this)"></div>
        </div>
        <div class="setting-row">
          <div class="setting-label-wrap">
            <div class="setting-label">Inactivity Alert</div>
            <div class="setting-desc">After 2h without a session</div>
          </div>
          <div class="toggle" id="toggleInactivity" onclick="App.toggleSetting(this)"></div>
        </div>
        <div class="setting-row">
          <div class="setting-label-wrap">
            <div class="setting-label">Evening Summary</div>
            <div class="setting-desc">End-of-day encouragement</div>
          </div>
          <div class="toggle" id="toggleEvening" onclick="App.toggleSetting(this)"></div>
        </div>
        <div class="setting-row">
          <div class="setting-label-wrap">
            <div class="setting-label">Session Sound</div>
            <div class="setting-desc">Soft tone on session end</div>
          </div>
          <div class="toggle on" id="toggleSound" onclick="App.toggleSetting(this)"></div>
        </div>
      </div>

      <!-- Theme -->
      <div class="settings-group">
        <div class="settings-group-label">Appearance</div>
        <div style="padding:8px 0 4px;">
          <div class="theme-chips">
            <button class="theme-chip active" data-theme="focus" onclick="App.setTheme('focus',this)">Focus</button>
            <button class="theme-chip" data-theme="calm" onclick="App.setTheme('calm',this)">Calm</button>
            <button class="theme-chip" data-theme="deep" onclick="App.setTheme('deep',this)">Deep</button>
          </div>
        </div>
      </div>

      <!-- PWA Install -->
      <div class="settings-group">
        <div class="settings-group-label">App</div>
        <div class="setting-row">
          <div class="setting-label-wrap">
            <div class="setting-label">Install to Home Screen</div>
            <div class="setting-desc">Add as PWA for offline use</div>
          </div>
          <button class="btn-secondary" style="height:36px;padding:0 14px;font-size:12px;" id="btnInstall">Install</button>
        </div>
        <div class="setting-row">
          <div class="setting-label-wrap">
            <div class="setting-label">Clear Local Data</div>
            <div class="setting-desc">Reset all sessions and tasks</div>
          </div>
          <button class="btn-secondary" style="height:36px;padding:0 14px;font-size:12px;color:var(--rose)" id="btnClearData">Clear</button>
        </div>
      </div>

      <!-- Supabase Config -->
      <div class="settings-group">
        <div class="settings-group-label">Supabase (Optional Cloud Sync)</div>
        <div class="setting-row" style="flex-direction:column;align-items:stretch;gap:10px;">
          <input class="form-input" id="sbUrl" placeholder="Supabase Project URL" style="margin:0">
          <input class="form-input" id="sbKey" placeholder="Supabase Anon Key" type="password" style="margin:0">
          <button class="btn-primary" style="height:44px;font-size:13px;" onclick="App.saveSupabaseConfig()">Connect Supabase</button>
        </div>
      </div>

      <div style="height:16px"></div>
    </div>

  </div><!-- end tabContent -->

  <!-- ════════════ BOTTOM NAV ════════════ -->
  <nav class="nav-bar">
    <button class="nav-item active" data-tab="home" onclick="App.switchTab('home',this)">
      <svg class="nav-icon" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9,22 9,12 15,12 15,22"/></svg>
      <span class="nav-label">Home</span>
    </button>
    <button class="nav-item" data-tab="plan" onclick="App.switchTab('plan',this)">
      <svg class="nav-icon" viewBox="0 0 24 24"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/><line x1="9" y1="12" x2="15" y2="12"/><line x1="9" y1="16" x2="13" y2="16"/></svg>
      <span class="nav-label">Plan</span>
    </button>
    <button class="nav-item" data-tab="backlog" onclick="App.switchTab('backlog',this)">
      <svg class="nav-icon" viewBox="0 0 24 24"><path d="M3 6h18M3 12h18M3 18h18"/></svg>
      <span class="nav-label">Backlog</span>
    </button>
    <button class="nav-item" data-tab="progress" onclick="App.switchTab('progress',this)">
      <svg class="nav-icon" viewBox="0 0 24 24"><polyline points="22,12 18,12 15,21 9,3 6,12 2,12"/></svg>
      <span class="nav-label">Progress</span>
    </button>
    <button class="nav-item" data-tab="settings" onclick="App.switchTab('settings',this)">
      <svg class="nav-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
      <span class="nav-label">Settings</span>
    </button>
  </nav>
</div>

<!-- ═══ FOCUS SESSION OVERLAY ═══ -->
<div class="session-overlay" id="sessionOverlay">
  <div class="session-bg"></div>
  <div class="session-gradient"></div>

  <div class="session-top">
    <div class="session-label">Focus Session</div>
    <div class="session-subject" id="sessionSubject">—</div>
    <div class="session-topic" id="sessionTopic">—</div>
  </div>

  <div style="display:flex;flex-direction:column;align-items:center;gap:8px;">
    <div class="session-timer" id="sessionTimer">00:00</div>
    <div class="session-status" id="sessionStatus">RUNNING</div>
  </div>

  <div class="session-controls">
    <button class="btn-session-end" id="btnEndSession">End Session</button>
    <button class="btn-session-pause" id="btnPauseSession">Pause</button>
  </div>
</div>

<!-- ═══ SHEET BACKDROP ═══ -->
<div class="sheet-backdrop" id="sheetBackdrop" onclick="App.closeSheet()"></div>

<!-- ═══ ADD DAY SHEET ═══ -->
<div class="bottom-sheet" id="sheetAddDay">
  <div class="sheet-handle"></div>
  <div class="sheet-title">Add Study Day</div>
  <div class="form-group">
    <label class="form-label">Day Label</label>
    <input class="form-input" id="inputDayLabel" placeholder="e.g., Day 1, Travel Day, Revision" maxlength="40">
  </div>
  <div class="form-group">
    <label class="form-label">Date (optional)</label>
    <input class="form-input" id="inputDayDate" type="date">
  </div>
  <div class="sheet-actions">
    <button class="btn-secondary" style="flex:1" onclick="App.closeSheet()">Cancel</button>
    <button class="btn-primary" style="flex:2" onclick="App.saveDay()">Add Day</button>
  </div>
</div>

<!-- ═══ ADD TASK SHEET ═══ -->
<div class="bottom-sheet" id="sheetAddTask">
  <div class="sheet-handle"></div>
  <div class="sheet-title">Add Task</div>
  <div class="form-group">
    <label class="form-label">Subject</label>
    <div class="subject-select" id="subjectSelect">
      <button class="subj-chip" data-subj="Quant" onclick="App.selectSubject(this)">Quant</button>
      <button class="subj-chip" data-subj="LR" onclick="App.selectSubject(this)">LR</button>
      <button class="subj-chip" data-subj="AR" onclick="App.selectSubject(this)">AR</button>
      <button class="subj-chip" data-subj="VA" onclick="App.selectSubject(this)">VA</button>
      <button class="subj-chip" data-subj="Practice" onclick="App.selectSubject(this)">Practice</button>
      <button class="subj-chip" data-subj="Other" onclick="App.selectSubject(this)">Other</button>
    </div>
  </div>
  <div class="form-group">
    <label class="form-label">Topic</label>
    <input class="form-input" id="inputTaskTopic" placeholder="e.g., Ratio & Proportion">
  </div>
  <div class="form-row">
    <div class="form-group">
      <label class="form-label">Est. Minutes</label>
      <input class="form-input" id="inputTaskMins" type="number" placeholder="45" min="1" max="600">
    </div>
  </div>
  <div class="sheet-actions">
    <button class="btn-secondary" style="flex:1" onclick="App.closeSheet()">Cancel</button>
    <button class="btn-primary" style="flex:2" onclick="App.saveTask()">Add Task</button>
  </div>
</div>

<!-- ═══ SESSION PICKER SHEET ═══ -->
<div class="bottom-sheet" id="sheetSessionPicker">
  <div class="sheet-handle"></div>
  <div class="sheet-title">Choose Task to Focus On</div>
  <div class="session-subject-list" id="sessionSubjectList"></div>
  <div style="padding:16px 16px 0;">
    <button class="btn-secondary" style="width:100%" onclick="App.closeSheet()">Cancel</button>
  </div>
</div>

<!-- ═══ REASSIGN SHEET ═══ -->
<div class="bottom-sheet" id="sheetReassign">
  <div class="sheet-handle"></div>
  <div class="sheet-title">Move to Day</div>
  <div id="reassignDayList" style="padding:0 16px;max-height:320px;overflow-y:auto;display:flex;flex-direction:column;gap:8px;"></div>
  <div style="padding:16px 16px 0;">
    <button class="btn-secondary" style="width:100%" onclick="App.closeSheet()">Cancel</button>
  </div>
</div>

<!-- ═══ PDF PROCESSING INDICATOR ═══ -->
<div id="pdfProcessing" style="display:none;position:fixed;inset:0;z-index:250;background:rgba(9,9,16,0.92);display:none;flex-direction:column;align-items:center;justify-content:center;gap:16px;">
  <div style="width:48px;height:48px;border:3px solid var(--border-mid);border-top-color:var(--indigo);border-radius:50%;animation:spin 0.8s linear infinite;"></div>
  <div style="font-size:14px;color:var(--text-2);" id="pdfStatus">Parsing PDF…</div>
</div>

<style>
  @keyframes spin { to { transform: rotate(360deg); } }
  #pdfProcessing { display: none; }
  #pdfProcessing.active { display: flex; }
</style>

<!-- ═══════════════════════════════════════════════
     PDF.JS
═══════════════════════════════════════════════ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
if (window.pdfjsLib) {
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
}
</script>

<!-- ═══════════════════════════════════════════════
     SUPABASE CLIENT (optional — loaded if configured)
═══════════════════════════════════════════════ -->
<script>
// ═══════════════════════════════════════════════════════════════════════
//  FOCUS ENGINE — Main Application Script
//  Architecture: Module-style IIFE with clear separation of concerns
// ═══════════════════════════════════════════════════════════════════════

const App = (() => {

  // ─── Subject color palette ───────────────────────────────────────────
  const SUBJECT_COLORS = {
    'Quant':    '#6366f1',
    'LR':       '#f59e0b',
    'AR':       '#10b981',
    'VA':       '#ec4899',
    'Practice': '#8b5cf6',
    'Other':    '#6b7294',
  };

  const ENCOURAGEMENTS = [
    '"Consistency beats intensity every single time."',
    '"Start small. Momentum beats motivation."',
    '"A focused hour is worth more than a distracted day."',
    '"Progress, not perfection — that\'s the standard."',
    '"Your effort today is tomorrow\'s advantage."',
    '"One task at a time. That\'s how mountains move."',
    '"The work doesn\'t care how you feel. Do it anyway."',
  ];

  // ─── State ───────────────────────────────────────────────────────────
  let state = {
    days: [],        // study_days
    tasks: [],       // study_tasks
    sessions: [],    // focus_sessions
    settings: {
      dayEndTime:   '23:00',
      dayStartTime: '06:00',
      notifications: { morning: false, inactivity: false, evening: false },
      sound:  true,
      theme:  'focus',
    },
    currentDayId:   null,   // active day id for task sheet
    reassignTaskId: null,
    selectedSubject: null,
  };

  // Active focus session
  let session = {
    active:    false,
    paused:    false,
    taskId:    null,
    subject:   '',
    topic:     '',
    startTime: null,
    pausedAt:  null,
    elapsed:   0,       // seconds accumulated
    timerRef:  null,
  };

  let deferredInstallPrompt = null;
  let clockRef = null;

  // ─── LocalStorage persistence ────────────────────────────────────────
  const DB = {
    save() {
      localStorage.setItem('fe_state', JSON.stringify({
        days: state.days,
        tasks: state.tasks,
        sessions: state.sessions,
        settings: state.settings,
      }));
    },
    load() {
      try {
        const saved = JSON.parse(localStorage.getItem('fe_state') || '{}');
        if (saved.days)     state.days = saved.days;
        if (saved.tasks)    state.tasks = saved.tasks;
        if (saved.sessions) state.sessions = saved.sessions;
        if (saved.settings) state.settings = Object.assign(state.settings, saved.settings);
      } catch(e) { console.warn('DB load failed', e); }
    }
  };

  // ─── Supabase integration ─────────────────────────────────────────────
  const Supa = {
    client: null,
    async init(url, key) {
      if (!url || !key) return false;
      const { createClient } = await import(`https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm`);
      Supa.client = createClient(url, key);
      return true;
    },
    async syncDays() {
      if (!Supa.client) return;
      const { data } = await Supa.client.from('study_days').select('*').order('created_at');
      if (data) { state.days = data; DB.save(); renderPlan(); renderHome(); }
    },
    async syncTasks() {
      if (!Supa.client) return;
      const { data } = await Supa.client.from('study_tasks').select('*').order('created_at');
      if (data) { state.tasks = data; DB.save(); renderPlan(); renderHome(); }
    },
    async syncSessions() {
      if (!Supa.client) return;
      const { data } = await Supa.client.from('focus_sessions').select('*').order('created_at');
      if (data) { state.sessions = data; DB.save(); renderProgress(); }
    },
    async insertDay(day) {
      if (!Supa.client) return;
      await Supa.client.from('study_days').insert(day);
    },
    async insertTask(task) {
      if (!Supa.client) return;
      await Supa.client.from('study_tasks').insert(task);
    },
    async updateTaskStatus(id, status) {
      if (!Supa.client) return;
      await Supa.client.from('study_tasks').update({ status }).eq('id', id);
    },
    async insertSession(s) {
      if (!Supa.client) return;
      await Supa.client.from('focus_sessions').insert(s);
    },
    async deleteTask(id) {
      if (!Supa.client) return;
      await Supa.client.from('study_tasks').delete().eq('id', id);
    },
  };

  // ─── Utilities ────────────────────────────────────────────────────────
  function uid() {
    return crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).slice(2) + Date.now();
  }

  function todayStr() {
    return new Date().toISOString().slice(0, 10);
  }

  function fmtTime(secs) {
    const h = Math.floor(secs / 3600);
    const m = Math.floor((secs % 3600) / 60);
    const s = secs % 60;
    if (h > 0) return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  }

  function fmtMins(m) {
    if (m < 60) return `${m}m`;
    const h = Math.floor(m/60), rem = m%60;
    return rem === 0 ? `${h}h` : `${h}h ${rem}m`;
  }

  function toast(msg, type='') {
    const el = document.createElement('div');
    el.className = `toast ${type}`;
    el.innerHTML = `<span>${msg}</span>`;
    document.getElementById('toast-container').appendChild(el);
    setTimeout(() => { el.style.opacity='0'; el.style.transform='translateY(-8px)'; el.style.transition='all 0.3s ease'; setTimeout(()=>el.remove(), 300); }, 2800);
  }

  function openSheet(id) {
    document.getElementById('sheetBackdrop').classList.add('active');
    document.getElementById(id).classList.add('active');
  }

  function closeSheet() {
    document.querySelectorAll('.bottom-sheet').forEach(s => s.classList.remove('active'));
    document.getElementById('sheetBackdrop').classList.remove('active');
    state.currentDayId = null;
    state.reassignTaskId = null;
  }

  // ─── Tab switching ────────────────────────────────────────────────────
  function switchTab(name, btn) {
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
    document.getElementById(`tab-${name}`).classList.add('active');
    if (btn) btn.classList.add('active');
    // Refresh relevant tab
    if (name === 'home')     renderHome();
    if (name === 'plan')     renderPlan();
    if (name === 'backlog')  renderBacklog();
    if (name === 'progress') renderProgress();
    if (name === 'settings') renderSettings();
    document.getElementById('tabContent').scrollTop = 0;
  }

  // ─── Clock & Ring ─────────────────────────────────────────────────────
  function startClock() {
    updateClock();
    clearInterval(clockRef);
    clockRef = setInterval(updateClock, 1000);
  }

  function updateClock() {
    const now = new Date();
    const h = now.getHours(), m = now.getMinutes();

    // Time display
    document.getElementById('liveTime').textContent =
      `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;

    // Date
    document.getElementById('liveDate').textContent =
      now.toLocaleDateString('en-IN', { weekday:'long', day:'numeric', month:'long' });

    // Greeting
    const g = h < 12 ? 'Good morning' : h < 17 ? 'Good afternoon' : 'Good evening';
    document.getElementById('greeting').textContent = g;

    // Countdown ring
    const [eh, em] = (state.settings.dayEndTime || '23:00').split(':').map(Number);
    const [sh, sm] = (state.settings.dayStartTime || '06:00').split(':').map(Number);
    const endSecs   = eh * 3600 + em * 60;
    const startSecs = sh * 3600 + sm * 60;
    const nowSecs   = h * 3600 + m * 60 + now.getSeconds();

    let remaining = endSecs - nowSecs;
    if (remaining < 0) remaining = 0;

    const totalDay = endSecs - startSecs;
    const progress = Math.max(0, Math.min(1, 1 - remaining / totalDay));

    const circumference = 2 * Math.PI * 74; // r=74
    const ring = document.getElementById('ringProgress');
    ring.setAttribute('stroke-dasharray', circumference);
    ring.setAttribute('stroke-dashoffset', circumference * (1 - progress));

    // Dynamic color shift (cool→warm as day progresses)
    const hue = Math.round(240 - progress * 160); // 240=blue, 80=yellow-green
    ring.style.stroke = `hsl(${hue}, 80%, 65%)`;

    const remH = Math.floor(remaining / 3600);
    const remM = Math.floor((remaining % 3600) / 60);
    document.getElementById('ringValue').textContent = `${remH}h ${remM}m`;
    document.getElementById('ringEnd').textContent = `ends at ${state.settings.dayEndTime}`;
  }

  // ─── Home Rendering ───────────────────────────────────────────────────
  function renderHome() {
    const today = todayStr();
    // Find today's study day
    const todayDay = state.days.find(d => d.date === today);
    const label = todayDay ? todayDay.label : 'No plan for today';
    document.getElementById('todayDayLabel').textContent = label;

    const todayTasks = todayDay
      ? state.tasks.filter(t => t.day_id === todayDay.id)
      : [];

    const total = todayTasks.length;
    const done  = todayTasks.filter(t => t.status === 'completed').length;
    const pct   = total > 0 ? Math.round((done / total) * 100) : 0;

    document.getElementById('completionPct').textContent  = `${pct}%`;
    document.getElementById('completionFill').style.width = `${pct}%`;
    document.getElementById('completionStat').textContent = `${done} / ${total} tasks`;

    // Group by subject
    const subjectMap = {};
    todayTasks.forEach(t => {
      if (!subjectMap[t.subject]) subjectMap[t.subject] = { tasks: [], done: 0, total: 0 };
      subjectMap[t.subject].tasks.push(t);
      subjectMap[t.subject].total += t.estimated_minutes || 0;
      if (t.status === 'completed') subjectMap[t.subject].done += t.estimated_minutes || 0;
    });

    const list = document.getElementById('subjectList');

    if (Object.keys(subjectMap).length === 0) {
      list.innerHTML = `<div class="empty-state">
        <div class="empty-icon">
          <svg width="24" height="24" fill="none" stroke="#5a5a7a" stroke-width="1.5" viewBox="0 0 24 24">
            <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
          </svg>
        </div>
        <div class="empty-title">No tasks for today</div>
        <div class="empty-sub">Head to Plan tab to set up today's study targets.</div>
      </div>`;
      return;
    }

    list.innerHTML = Object.entries(subjectMap).map(([subj, data]) => {
      const color = SUBJECT_COLORS[subj] || SUBJECT_COLORS.Other;
      const topics = data.tasks.map(t => t.topic).join(', ');
      const remaining = data.total - data.done;
      const pct = data.total > 0 ? (data.done / data.total) * 100 : 0;
      const allDone = remaining <= 0;

      return `<div class="subject-card">
        <div class="subject-card-top">
          <div class="subject-info">
            <div class="subject-name-row">
              <div class="subject-dot" style="background:${color}"></div>
              <div>
                <div class="subject-name">${subj}</div>
                <div class="subject-topics">${topics}</div>
              </div>
            </div>
          </div>
          <div class="subject-time ${allDone ? 'done' : ''}">
            ${allDone ? '✓ Done' : fmtMins(remaining)}
          </div>
        </div>
        <div class="subject-progress">
          <div class="subject-progress-fill" style="width:${pct}%;background:${color}"></div>
        </div>
      </div>`;
    }).join('');
  }

  // ─── Plan Rendering ───────────────────────────────────────────────────
  function renderPlan() {
    const list = document.getElementById('daysList');
    if (state.days.length === 0) {
      list.innerHTML = `<div class="empty-state">
        <div class="empty-icon">
          <svg width="24" height="24" fill="none" stroke="#5a5a7a" stroke-width="1.5" viewBox="0 0 24 24">
            <path d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01"/>
          </svg>
        </div>
        <div class="empty-title">Plan is empty</div>
        <div class="empty-sub">Add study days or import a PDF plan to get started.</div>
      </div>`;
      return;
    }

    list.innerHTML = state.days.map((day, idx) => {
      const tasks = state.tasks.filter(t => t.day_id === day.id);
      const done  = tasks.filter(t => t.status === 'completed').length;
      const today = day.date === todayStr();

      return `<div class="day-card" id="daycard-${day.id}">
        <div class="day-card-header" onclick="App.toggleDayCard('${day.id}')">
          <div class="day-number-badge">${day.label || `Day ${idx+1}`}</div>
          <div class="day-info">
            <div class="day-label">${day.label}${today ? ' <span class="badge badge-indigo">Today</span>' : ''}</div>
            <div class="day-meta">${day.date || 'No date'} · ${tasks.length} tasks · ${done}/${tasks.length} done</div>
          </div>
          <svg class="day-chevron" viewBox="0 0 24 24"><polyline points="9,18 15,12 9,6"/></svg>
        </div>
        <div class="day-tasks">
          ${tasks.map(task => renderTaskRow(task)).join('')}
          <div class="day-add-task" onclick="App.openAddTask('${day.id}')">
            <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
            Add task
          </div>
        </div>
      </div>`;
    }).join('');
  }

  function renderTaskRow(task) {
    const color = SUBJECT_COLORS[task.subject] || SUBJECT_COLORS.Other;
    const done  = task.status === 'completed';
    return `<div class="task-item">
      <div class="task-check ${done ? 'done' : ''}" onclick="App.toggleTask('${task.id}')">
        ${done ? '<svg width="12" height="12" fill="none" stroke="white" stroke-width="3" viewBox="0 0 24 24"><polyline points="20,6 9,17 4,12"/></svg>' : ''}
      </div>
      <div class="task-info">
        <div class="task-subject" style="color:${color}">${task.subject}</div>
        <div class="task-topic">${task.topic}</div>
      </div>
      <div class="task-time">${fmtMins(task.estimated_minutes || 0)}</div>
      <div class="task-delete" onclick="App.deleteTask('${task.id}')">
        <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="3,6 5,6 21,6"/><path d="M19 6l-1 14a2 2 0 01-2 2H8a2 2 0 01-2-2L5 6m3 0V4a1 1 0 011-1h4a1 1 0 011 1v2"/></svg>
      </div>
    </div>`;
  }

  function toggleDayCard(dayId) {
    const card = document.getElementById(`daycard-${dayId}`);
    if (card) card.classList.toggle('expanded');
  }

  // ─── Backlog Rendering ────────────────────────────────────────────────
  function renderBacklog() {
    const today = todayStr();
    // Tasks from days that are past today (date < today) and not completed
    const pending = state.tasks.filter(t => {
      if (t.status === 'completed') return false;
      const day = state.days.find(d => d.id === t.day_id);
      if (!day || !day.date) return false;
      return day.date < today;
    });

    document.getElementById('backlogCount').textContent = pending.length;
    const totalMins = pending.reduce((a, t) => a + (t.estimated_minutes || 0), 0);
    document.getElementById('backlogMins').textContent = totalMins;

    // Max days old
    const daysOld = pending.reduce((max, t) => {
      const day = state.days.find(d => d.id === t.day_id);
      if (!day || !day.date) return max;
      const diff = Math.floor((new Date(today) - new Date(day.date)) / 86400000);
      return Math.max(max, diff);
    }, 0);
    document.getElementById('backlogDays').textContent = daysOld;

    const list = document.getElementById('pendingList');
    if (pending.length === 0) {
      list.innerHTML = `<div class="empty-state">
        <div class="empty-icon">
          <svg width="24" height="24" fill="none" stroke="#5a5a7a" stroke-width="1.5" viewBox="0 0 24 24">
            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
        </div>
        <div class="empty-title">All clear</div>
        <div class="empty-sub">No pending units. Your flow is uninterrupted.</div>
      </div>`;
      return;
    }

    list.innerHTML = pending.map(t => {
      const color = SUBJECT_COLORS[t.subject] || SUBJECT_COLORS.Other;
      const day = state.days.find(d => d.id === t.day_id);
      return `<div class="pending-item">
        <div class="pending-dot" style="background:${color}"></div>
        <div class="pending-info">
          <div class="pending-subject" style="color:${color}">${t.subject}</div>
          <div class="pending-topic">${t.topic}</div>
          <div class="pending-origin">From ${day ? day.label : 'Unknown'}</div>
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px;">
          <div class="pending-time">${fmtMins(t.estimated_minutes || 0)}</div>
          <button class="btn-reassign" onclick="App.openReassign('${t.id}')">Move</button>
        </div>
      </div>`;
    }).join('');
  }

  // ─── Progress Rendering ───────────────────────────────────────────────
  function renderProgress() {
    const today = new Date();
    const last7 = Array.from({length:7}, (_,i) => {
      const d = new Date(today);
      d.setDate(d.getDate() - (6-i));
      return d.toISOString().slice(0,10);
    });

    // Sessions in last 7 days
    const recent = state.sessions.filter(s => last7.includes(s.session_date));

    // Consistency: days with at least one session
    const activeDays = new Set(recent.map(s => s.session_date)).size;
    const consistency = Math.round((activeDays / 7) * 100);

    // Total time
    const totalSecs = recent.reduce((a,s) => a + (s.duration_seconds||0), 0);
    const totalMins = Math.floor(totalSecs / 60);

    document.getElementById('metricConsistency').textContent = `${consistency}%`;
    document.getElementById('metricConsistencySub').textContent = `${activeDays} of 7 days`;
    document.getElementById('metricTotal').textContent = totalMins >= 60 ? `${Math.floor(totalMins/60)}h` : `${totalMins}m`;
    document.getElementById('metricSessions').textContent = recent.length;
    document.getElementById('metricAvg').textContent = activeDays > 0 ? `${Math.round(totalMins/activeDays)}m` : '0m';

    // Weekly bars
    const days = ['S','M','T','W','T','F','S'];
    const weekBars = document.getElementById('weekBars');
    weekBars.innerHTML = last7.map((date, i) => {
      const dayMins = state.sessions
        .filter(s => s.session_date === date)
        .reduce((a,s) => a + Math.floor((s.duration_seconds||0)/60), 0);
      const maxMins = 240;
      const pct = Math.min(100, Math.round((dayMins / maxMins) * 100));
      const d = new Date(date);
      const label = ['S','M','T','W','T','F','S'][d.getDay()];
      const isToday = date === todayStr();
      return `<div class="week-day-col">
        <div class="week-bar">
          <div class="week-bar-fill" style="height:${pct}%;${isToday?'background:linear-gradient(180deg,#f59e0b,rgba(245,158,11,0.5))':''}"></div>
        </div>
        <div class="week-day-label" style="${isToday?'color:var(--indigo);font-weight:600':''}">${label}</div>
      </div>`;
    }).join('');

    // Subject distribution
    const subjectSecs = {};
    recent.forEach(s => {
      subjectSecs[s.subject] = (subjectSecs[s.subject]||0) + (s.duration_seconds||0);
    });

    const totalSubSecs = Object.values(subjectSecs).reduce((a,b)=>a+b, 0);
    const subDist = document.getElementById('subjectDist');

    if (totalSubSecs === 0) {
      subDist.innerHTML = '<div style="font-size:13px;color:var(--text-3);text-align:center;padding:10px 0">No sessions yet</div>';
    } else {
      subDist.innerHTML = Object.entries(subjectSecs)
        .sort(([,a],[,b]) => b-a)
        .map(([subj, secs]) => {
          const color = SUBJECT_COLORS[subj] || SUBJECT_COLORS.Other;
          const pct = Math.round((secs / totalSubSecs) * 100);
          return `<div class="dist-row">
            <div class="dist-subject">${subj}</div>
            <div class="dist-bar-wrap">
              <div class="dist-bar-fill" style="width:${pct}%;background:${color}"></div>
            </div>
            <div class="dist-pct">${pct}%</div>
          </div>`;
        }).join('');
    }

    // Encouragement
    const enc = ENCOURAGEMENTS[Math.floor(Math.random() * ENCOURAGEMENTS.length)];
    document.getElementById('encourageText').textContent = enc;

    // Date range label
    const from = new Date(last7[0]).toLocaleDateString('en-IN', {day:'numeric',month:'short'});
    const to   = new Date(last7[6]).toLocaleDateString('en-IN', {day:'numeric',month:'short'});
    document.getElementById('progressRange').textContent = `${from} – ${to}`;
  }

  // ─── Settings Rendering ───────────────────────────────────────────────
  function renderSettings() {
    document.getElementById('settingEndTime').value   = state.settings.dayEndTime;
    document.getElementById('settingStartTime').value = state.settings.dayStartTime;

    const n = state.settings.notifications;
    setToggleState('toggleMorning',    n.morning);
    setToggleState('toggleInactivity', n.inactivity);
    setToggleState('toggleEvening',    n.evening);
    setToggleState('toggleSound',      state.settings.sound);

    // Theme
    document.querySelectorAll('.theme-chip').forEach(c => {
      c.classList.toggle('active', c.dataset.theme === state.settings.theme);
    });

    // Supabase
    const sc = state.settings.supabase || {};
    if (sc.url) document.getElementById('sbUrl').value = sc.url;
  }

  function setToggleState(id, on) {
    const el = document.getElementById(id);
    if (el) el.classList.toggle('on', !!on);
  }

  function toggleSetting(el) {
    el.classList.toggle('on');
    const id = el.id;
    const on = el.classList.contains('on');
    if (id === 'toggleMorning')    state.settings.notifications.morning    = on;
    if (id === 'toggleInactivity') state.settings.notifications.inactivity = on;
    if (id === 'toggleEvening')    state.settings.notifications.evening    = on;
    if (id === 'toggleSound')      state.settings.sound = on;
    DB.save();
    if (on && (id === 'toggleMorning' || id === 'toggleEvening' || id === 'toggleInactivity')) {
      requestNotificationPermission();
    }
  }

  function setTheme(theme, btn) {
    state.settings.theme = theme;
    document.querySelectorAll('.theme-chip').forEach(c => c.classList.remove('active'));
    btn.classList.add('active');
    document.documentElement.dataset.theme = theme;
    DB.save();
  }

  function saveSupabaseConfig() {
    const url = document.getElementById('sbUrl').value.trim();
    const key = document.getElementById('sbKey').value.trim();
    if (!url || !key) { toast('Enter both URL and key', 'error'); return; }
    state.settings.supabase = { url, key };
    DB.save();
    Supa.init(url, key).then(ok => {
      if (ok) {
        toast('Supabase connected! Syncing…', 'success');
        Supa.syncDays(); Supa.syncTasks(); Supa.syncSessions();
      } else {
        toast('Connection failed — check credentials', 'error');
      }
    });
  }

  // ─── Task management ──────────────────────────────────────────────────
  function openAddTask(dayId) {
    state.currentDayId = dayId;
    state.selectedSubject = null;
    document.querySelectorAll('.subj-chip').forEach(c => c.classList.remove('active'));
    document.getElementById('inputTaskTopic').value = '';
    document.getElementById('inputTaskMins').value  = '';
    openSheet('sheetAddTask');
  }

  function selectSubject(btn) {
    document.querySelectorAll('.subj-chip').forEach(c => c.classList.remove('active'));
    btn.classList.add('active');
    state.selectedSubject = btn.dataset.subj;
  }

  function saveTask() {
    if (!state.currentDayId) { toast('No day selected','error'); return; }
    const subj  = state.selectedSubject;
    const topic = document.getElementById('inputTaskTopic').value.trim();
    const mins  = parseInt(document.getElementById('inputTaskMins').value) || 0;

    if (!subj)  { toast('Pick a subject', 'error'); return; }
    if (!topic) { toast('Enter a topic', 'error');  return; }

    const task = {
      id: uid(), day_id: state.currentDayId,
      subject: subj, topic, estimated_minutes: mins,
      status: 'pending', created_at: new Date().toISOString()
    };

    state.tasks.push(task);
    DB.save();
    Supa.insertTask(task);
    closeSheet();
    renderPlan();
    renderHome();
    toast('Task added', 'success');
  }

  function toggleTask(taskId) {
    const task = state.tasks.find(t => t.id === taskId);
    if (!task) return;
    task.status = task.status === 'completed' ? 'pending' : 'completed';
    DB.save();
    Supa.updateTaskStatus(taskId, task.status);
    renderPlan();
    renderHome();
  }

  function deleteTask(taskId) {
    state.tasks = state.tasks.filter(t => t.id !== taskId);
    DB.save();
    Supa.deleteTask(taskId);
    renderPlan();
    renderHome();
    toast('Task removed');
  }

  // ─── Day management ───────────────────────────────────────────────────
  function saveDay() {
    const label = document.getElementById('inputDayLabel').value.trim();
    const date  = document.getElementById('inputDayDate').value;
    if (!label) { toast('Enter a label', 'error'); return; }

    const day = { id: uid(), label, date: date || null, created_at: new Date().toISOString() };
    state.days.push(day);
    DB.save();
    Supa.insertDay(day);
    closeSheet();
    renderPlan();
    renderHome();
    toast('Day added', 'success');
  }

  // ─── Backlog reassign ─────────────────────────────────────────────────
  function openReassign(taskId) {
    state.reassignTaskId = taskId;
    const container = document.getElementById('reassignDayList');
    container.innerHTML = state.days.map(day => {
      return `<div class="session-pick-item" onclick="App.reassignTask('${day.id}')">
        <div class="pick-info">
          <div class="pick-subj">${day.label}</div>
          <div style="font-size:12px;color:var(--text-3)">${day.date || 'No date'}</div>
        </div>
      </div>`;
    }).join('') || '<div style="padding:16px;color:var(--text-3);font-size:13px">No days available</div>';
    openSheet('sheetReassign');
  }

  function reassignTask(dayId) {
    const task = state.tasks.find(t => t.id === state.reassignTaskId);
    if (task) {
      task.day_id = dayId;
      DB.save();
      Supa.insertTask(task); // would be update in real scenario
    }
    closeSheet();
    renderBacklog();
    renderHome();
    toast('Task moved', 'success');
  }

  // ─── Focus Session ────────────────────────────────────────────────────
  function startSessionFlow() {
    const today = todayStr();
    const todayDay = state.days.find(d => d.date === today);
    const pending = todayDay
      ? state.tasks.filter(t => t.day_id === todayDay.id && t.status === 'pending')
      : [];

    // Also include backlog items
    const backlog = state.tasks.filter(t => {
      if (t.status === 'completed') return false;
      const day = state.days.find(d => d.id === t.day_id);
      return day && day.date && day.date < today;
    });

    const allAvailable = [...pending, ...backlog];

    if (allAvailable.length === 0) {
      toast('No pending tasks — great job!', 'success');
      return;
    }

    // Show picker
    const list = document.getElementById('sessionSubjectList');
    list.innerHTML = allAvailable.map(t => {
      const color = SUBJECT_COLORS[t.subject] || SUBJECT_COLORS.Other;
      const day = state.days.find(d => d.id === t.day_id);
      return `<div class="session-pick-item" onclick="App.startSession('${t.id}')">
        <div class="pick-dot" style="background:${color}"></div>
        <div class="pick-info">
          <div class="pick-subj" style="color:${color}">${t.subject}</div>
          <div class="pick-topic">${t.topic}</div>
          ${day && day.date !== today ? `<div style="font-size:11px;color:var(--text-3)">From ${day.label}</div>` : ''}
        </div>
        <div class="pick-time">${fmtMins(t.estimated_minutes||0)}</div>
      </div>`;
    }).join('');
    openSheet('sheetSessionPicker');
  }

  function startSession(taskId) {
    const task = state.tasks.find(t => t.id === taskId);
    if (!task) return;

    closeSheet();

    session.active    = true;
    session.paused    = false;
    session.taskId    = taskId;
    session.subject   = task.subject;
    session.topic     = task.topic;
    session.startTime = Date.now();
    session.elapsed   = 0;

    document.getElementById('sessionSubject').textContent = task.subject;
    document.getElementById('sessionTopic').textContent   = task.topic;
    document.getElementById('sessionTimer').textContent   = '00:00';
    document.getElementById('sessionStatus').textContent  = 'RUNNING';
    document.getElementById('btnPauseSession').textContent = 'Pause';
    document.getElementById('sessionOverlay').classList.add('active');

    session.timerRef = setInterval(tickSession, 1000);
  }

  function tickSession() {
    if (!session.active || session.paused) return;
    session.elapsed = Math.floor((Date.now() - session.startTime) / 1000);
    document.getElementById('sessionTimer').textContent = fmtTime(session.elapsed);
  }

  function pauseSession() {
    if (!session.active) return;
    if (!session.paused) {
      session.paused  = true;
      session.pausedAt = Date.now();
      document.getElementById('btnPauseSession').textContent = 'Resume';
      document.getElementById('sessionStatus').textContent  = 'PAUSED';
    } else {
      const pausedDuration = Date.now() - session.pausedAt;
      session.startTime += pausedDuration;
      session.paused   = false;
      session.pausedAt = null;
      document.getElementById('btnPauseSession').textContent = 'Pause';
      document.getElementById('sessionStatus').textContent  = 'RUNNING';
    }
  }

  function endSession() {
    if (!session.active) return;
    clearInterval(session.timerRef);

    const finalElapsed = session.elapsed;
    document.getElementById('sessionOverlay').classList.remove('active');

    if (finalElapsed < 10) {
      session.active = false;
      return;
    }

    // Save session
    const record = {
      id: uid(),
      subject: session.subject,
      topic: session.topic,
      duration_seconds: finalElapsed,
      session_date: todayStr(),
      created_at: new Date().toISOString(),
    };

    state.sessions.push(record);

    // Auto-complete task if session covers estimated time
    const task = state.tasks.find(t => t.id === session.taskId);
    if (task) {
      const sesMins = Math.floor(finalElapsed / 60);
      if (sesMins >= (task.estimated_minutes || 0) * 0.8) {
        task.status = 'completed';
        Supa.updateTaskStatus(task.id, 'completed');
      }
    }

    DB.save();
    Supa.insertSession(record);
    session.active = false;

    renderHome();
    renderProgress();
    renderBacklog();

    const mins = Math.floor(finalElapsed / 60);
    toast(`Session saved — ${fmtTime(finalElapsed)} focused`, 'success');

    if (state.settings.sound) playEndTone();
  }

  function playEndTone() {
    try {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.connect(gain); gain.connect(ctx.destination);
      osc.frequency.value = 528;
      gain.gain.setValueAtTime(0.15, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 1.2);
      osc.start(); osc.stop(ctx.currentTime + 1.2);
    } catch(e) {}
  }

  // ─── PDF Import ───────────────────────────────────────────────────────
  async function handlePDFImport(file) {
    if (!file || file.type !== 'application/pdf') {
      toast('Please select a valid PDF', 'error'); return;
    }

    const proc = document.getElementById('pdfProcessing');
    proc.classList.add('active');
    document.getElementById('pdfStatus').textContent = 'Reading PDF…';

    try {
      const arrayBuffer = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

      let fullText = '';
      document.getElementById('pdfStatus').textContent = `Parsing ${pdf.numPages} pages…`;

      for (let p = 1; p <= pdf.numPages; p++) {
        const page = await pdf.getPage(p);
        const content = await page.getTextContent();
        fullText += content.items.map(i => i.str).join(' ') + '\n';
      }

      document.getElementById('pdfStatus').textContent = 'Extracting plan…';
      const parsed = parsePDFText(fullText);

      if (parsed.days.length === 0) {
        proc.classList.remove('active');
        toast('Could not detect study plan structure', 'error');
        return;
      }

      // Import parsed data
      let addedDays = 0, addedTasks = 0;
      for (const dayData of parsed.days) {
        const day = { id: uid(), label: dayData.label, date: dayData.date, created_at: new Date().toISOString() };
        state.days.push(day);
        Supa.insertDay(day);
        addedDays++;

        for (const task of dayData.tasks) {
          const t = {
            id: uid(), day_id: day.id,
            subject: task.subject, topic: task.topic,
            estimated_minutes: task.estimated_minutes,
            status: 'pending', created_at: new Date().toISOString()
          };
          state.tasks.push(t);
          Supa.insertTask(t);
          addedTasks++;
        }
      }

      DB.save();
      proc.classList.remove('active');
      renderPlan(); renderHome();
      toast(`Imported ${addedDays} days, ${addedTasks} tasks`, 'success');

    } catch(err) {
      console.error('PDF error:', err);
      proc.classList.remove('active');
      toast('PDF parsing failed — check format', 'error');
    }
  }

  function parsePDFText(text) {
    /*
      Expected PDF format:
        Day 1
        Quant:
        • Ratio & Proportion
        • Percentages
        LR:
        • Seating Arrangement
        Day 2
        VA:
        • Reading Comprehension
      ...
    */
    const lines = text.split(/\n|\r/).map(l => l.trim()).filter(Boolean);
    const days  = [];
    const SUBJECTS = ['Quant', 'LR', 'AR', 'VA', 'Practice', 'DI', 'RC', 'Verbal', 'Reasoning'];

    let currentDay  = null;
    let currentSubj = null;

    // Regex patterns
    const dayPattern  = /^Day\s+(\d+)/i;
    const subjPattern = new RegExp(`^(${SUBJECTS.join('|')})[:\\s]`, 'i');

    for (const line of lines) {
      const dayMatch = line.match(dayPattern);
      if (dayMatch) {
        currentDay = { label: line.trim(), date: null, tasks: [] };
        days.push(currentDay);
        currentSubj = null;
        continue;
      }

      const subjMatch = line.match(subjPattern);
      if (subjMatch && currentDay) {
        // Normalize subject name
        const raw = subjMatch[1].toLowerCase();
        currentSubj = raw === 'quant' ? 'Quant'
          : raw === 'lr' || raw === 'reasoning' ? 'LR'
          : raw === 'ar' || raw === 'di' ? 'AR'
          : raw === 'va' || raw === 'verbal' || raw === 'rc' || raw === 'reading comprehension' ? 'VA'
          : 'Practice';
        continue;
      }

      // Topic line (bullet points or plain)
      if (currentDay && currentSubj) {
        const topic = line.replace(/^[•\-*►▶\d\.]\s*/, '').trim();
        if (topic.length > 3 && topic.length < 120) {
          // Estimate minutes based on topic keywords
          let mins = 45;
          const lower = topic.toLowerCase();
          if (lower.includes('test') || lower.includes('mock') || lower.includes('full'))   mins = 120;
          if (lower.includes('revision') || lower.includes('review'))                        mins = 30;
          if (lower.includes('practice') || lower.includes('exercise'))                      mins = 60;

          currentDay.tasks.push({ subject: currentSubj, topic, estimated_minutes: mins });
        }
      }
    }

    return { days };
  }

  // ─── Notifications ────────────────────────────────────────────────────
  async function requestNotificationPermission() {
    if (!('Notification' in window)) return;
    if (Notification.permission === 'default') {
      await Notification.requestPermission();
    }
  }

  function sendLocalNotification(title, body) {
    if (Notification.permission !== 'granted') return;
    new Notification(title, { body, icon: 'icons/icon-192.png', badge: 'icons/icon-192.png' });
  }

  function scheduleNotifications() {
    // Check and send notifications based on settings + current time
    const now = new Date();
    const h   = now.getHours();
    const n   = state.settings.notifications;

    if (n.morning && h === 7 && now.getMinutes() === 0) {
      sendLocalNotification('Focus Engine', 'Start small. Momentum beats motivation.');
    }

    if (n.evening && h === 20 && now.getMinutes() === 0) {
      const today = todayStr();
      const todayDay = state.days.find(d => d.date === today);
      if (todayDay) {
        const tasks = state.tasks.filter(t => t.day_id === todayDay.id);
        const done  = tasks.filter(t => t.status === 'completed').length;
        sendLocalNotification('Focus Engine',
          `Day wrapping up — ${done}/${tasks.length} tasks complete. A short sprint keeps the day alive.`);
      }
    }
  }

  // ─── PWA Install ──────────────────────────────────────────────────────
  function handleInstall() {
    if (deferredInstallPrompt) {
      deferredInstallPrompt.prompt();
      deferredInstallPrompt.userChoice.then(c => {
        if (c.outcome === 'accepted') toast('App installed!', 'success');
        deferredInstallPrompt = null;
      });
    } else {
      toast('Open in Chrome and use "Add to Home Screen" from the menu', '');
    }
  }

  // ─── Supabase initial load ────────────────────────────────────────────
  async function trySupabaseInit() {
    const sc = state.settings.supabase;
    if (sc && sc.url && sc.key) {
      const ok = await Supa.init(sc.url, sc.key);
      if (ok) { Supa.syncDays(); Supa.syncTasks(); Supa.syncSessions(); }
    }
  }

  // ─── Data clear ───────────────────────────────────────────────────────
  function clearData() {
    if (!confirm('Clear all local data? This cannot be undone.')) return;
    state.days = []; state.tasks = []; state.sessions = [];
    DB.save();
    renderHome(); renderPlan(); renderBacklog(); renderProgress();
    toast('Data cleared');
  }

  // ─── Init ─────────────────────────────────────────────────────────────
  function init() {
    DB.load();

    // Apply theme
    if (state.settings.theme) document.documentElement.dataset.theme = state.settings.theme;

    startClock();
    renderHome();
    renderProgress();

    // Service Worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js')
        .then(() => console.log('[FE] SW registered'))
        .catch(err => console.warn('[FE] SW error', err));
    }

    // Event bindings
    document.getElementById('btnStartSession').addEventListener('click', startSessionFlow);
    document.getElementById('btnEndSession').addEventListener('click', endSession);
    document.getElementById('btnPauseSession').addEventListener('click', pauseSession);
    document.getElementById('btnAddDay').addEventListener('click', () => {
      document.getElementById('inputDayLabel').value = '';
      document.getElementById('inputDayDate').value  = todayStr();
      openSheet('sheetAddDay');
    });

    document.getElementById('btnImportPDF').addEventListener('click', () => {
      document.getElementById('pdfFileInput').click();
    });

    document.getElementById('pdfFileInput').addEventListener('change', e => {
      if (e.target.files[0]) handlePDFImport(e.target.files[0]);
      e.target.value = '';
    });

    document.getElementById('btnInstall').addEventListener('click', handleInstall);
    document.getElementById('btnClearData').addEventListener('click', clearData);

    // Settings live save
    ['settingEndTime', 'settingStartTime'].forEach(id => {
      document.getElementById(id).addEventListener('change', e => {
        if (id === 'settingEndTime')   state.settings.dayEndTime   = e.target.value;
        if (id === 'settingStartTime') state.settings.dayStartTime = e.target.value;
        DB.save();
      });
    });

    // PWA install prompt
    window.addEventListener('beforeinstallprompt', e => {
      e.preventDefault();
      deferredInstallPrompt = e;
    });

    // Notification check interval
    setInterval(scheduleNotifications, 60000);
    scheduleNotifications();

    // Supabase
    trySupabaseInit();
  }

  // Public API
  return {
    init, switchTab, toggleDayCard,
    openAddTask, selectSubject, saveTask,
    saveDay, toggleTask, deleteTask,
    startSession, startSessionFlow, pauseSession: () => pauseSession(), endSession,
    openReassign, reassignTask,
    toggleSetting, setTheme, saveSupabaseConfig,
    clearData, handleInstall, closeSheet,
  };

})();

// Boot
document.addEventListener('DOMContentLoaded', App.init);
</script>
</body>
</html>
